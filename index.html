<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Ruang Server</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase SDK as ES module
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, orderBy, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Make Firebase available globally
        window.firebaseApp = null;
        window.db = null;
        window.firebaseFunctions = {
            addDoc,
            getDocs,
            updateDoc,
            deleteDoc,
            doc,
            collection,
            query,
            orderBy,
            onSnapshot,
            serverTimestamp
        };
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCVnirSmPXHVHf7QatrW9zHFWtqhHP5oQs",
            authDomain: "monitoring-ruang-server-8a72e.firebaseapp.com",
            projectId: "monitoring-ruang-server-8a72e",
            storageBucket: "monitoring-ruang-server-8a72e.firebasestorage.app",
            messagingSenderId: "237267145791",
            appId: "1:237267145791:web:f8fa417adc769a1a48548a",
            measurementId: "G-W8P40CGS2M"
        };
        
        // Initialize Firebase
        async function initializeFirebase() {
            try {
                // Check if config is set
                if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                    console.log('Firebase config needs to be configured');
                    document.getElementById('firebaseStatus').innerHTML = '<span style="color: orange;">‚ö†Ô∏è Firebase belum dikonfigurasi</span>';
                    return false;
                }
                
                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                
                // Check connection
                const testQuery = query(collection(window.db, 'monitoring_data'), orderBy('createdAt', 'desc'));
                await getDocs(testQuery);
                
                document.getElementById('firebaseStatus').innerHTML = '<span style="color: green;">üü¢ Firebase Terhubung</span>';
                return true;
            } catch (error) {
                console.error('Firebase initialization error:', error);
                document.getElementById('firebaseStatus').innerHTML = '<span style="color: red;">üî¥ Firebase Error: ' + error.message + '</span>';
                return false;
            }
        }
        
        window.initializeFirebase = initializeFirebase;
    </script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-server"></i>
                    <h1>Monitoring Ruang Server</h1>
                </div>
                <div class="header-info">
                    <span class="date-display" id="currentDate"></span>
                    <span id="firebaseStatus" style="font-size: 0.8rem; margin-left: 15px;">üîÑ Loading...</span>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                Dashboard
            </button>
            <button class="nav-tab" data-tab="input">
                <i class="fas fa-plus-circle"></i>
                Input Data
            </button>
            <button class="nav-tab" data-tab="history">
                <i class="fas fa-history"></i>
                Riwayat
            </button>
            <button class="nav-tab" data-tab="reports">
                <i class="fas fa-chart-bar"></i>
                Laporan
            </button>
            <button class="nav-tab" data-tab="config">
                <i class="fas fa-cog"></i>
                Konfigurasi
            </button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <section class="tab-content active" id="dashboard">
                <div class="status-cards">
                    <div class="status-card temperature">
                        <div class="card-icon">
                            <i class="fas fa-thermometer-half"></i>
                        </div>
                        <div class="card-info">
                            <h3>Suhu Rata-rata</h3>
                            <p class="value" id="avgTemp">-- ¬∞C</p>
                            <span class="status normal" id="tempStatus">Normal</span>
                        </div>
                    </div>
                    <div class="status-card humidity">
                        <div class="card-icon">
                            <i class="fas fa-water"></i>
                        </div>
                        <div class="card-info">
                            <h3>Kelembaban</h3>
                            <p class="value" id="avgHumidity">-- %</p>
                            <span class="status normal" id="humidityStatus">Normal</span>
                        </div>
                    </div>
                    <div class="status-card power">
                        <div class="card-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div class="card-info">
                            <h3>Daya Listrik</h3>
                            <p class="value" id="totalPower">-- kW</p>
                            <span class="status normal" id="powerStatus">Normal</span>
                        </div>
                    </div>
                    <div class="status-card devices">
                        <div class="card-icon">
                            <i class="fas fa-desktop"></i>
                        </div>
                        <div class="card-info">
                            <h3>Perangkat Aktif</h3>
                            <p class="value" id="activeDevices">--</p>
                            <span class="status normal" id="deviceStatus">Baik</span>
                        </div>
                    </div>
                </div>

                <div class="charts-container">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-line"></i> Grafik Suhu & Kelembaban</h3>
                            <select id="chartPeriod" class="chart-period-select">
                                <option value="7">7 Hari Terakhir</option>
                                <option value="14">14 Hari Terakhir</option>
                                <option value="30">30 Hari Terakhir</option>
                            </select>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="tempHumidityChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-bar"></i> Distribusi Status Perangkat</h3>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="deviceStatusChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="quick-stats">
                    <div class="quick-stat-card">
                        <h4><i class="fas fa-exclamation-triangle"></i> Peringatan Aktif</h4>
                        <p class="count" id="activeAlerts">0</p>
                    </div>
                    <div class="quick-stat-card">
                        <h4><i class="fas fa-check-circle"></i> Total Pencatatan</h4>
                        <p class="count" id="totalRecords">0</p>
                    </div>
                    <div class="quick-stat-card">
                        <h4><i class="fas fa-clock"></i> Update Terakhir</h4>
                        <p class="time" id="lastUpdate">--:--</p>
                    </div>
                    <div class="quick-stat-card">
                        <h4><i class="fas fa-users"></i> Online</h4>
                        <p class="count" id="onlineUsers">1</p>
                    </div>
                </div>
            </section>

            <!-- Input Data Section -->
            <section class="tab-content" id="input">
                <div class="input-section">
                    <div class="section-header">
                        <h2><i class="fas fa-plus-circle"></i> Input Data Monitoring</h2>
                    </div>
                    
                    <form id="monitoringForm" class="monitoring-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="entryDate"><i class="fas fa-calendar"></i> Tanggal</label>
                                <input type="date" id="entryDate" name="entryDate" required>
                            </div>
                            <div class="form-group">
                                <label for="entryTime"><i class="fas fa-clock"></i> Waktu</label>
                                <input type="time" id="entryTime" name="entryTime" required>
                            </div>
                        </div>

                        <div class="form-section-title">
                            <h3><i class="fas fa-server"></i> Kondisi Ruangan</h3>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="temperature"><i class="fas fa-thermometer-half"></i> Suhu (¬∞C)</label>
                                <input type="number" id="temperature" name="temperature" step="0.1" placeholder="Contoh: 22.5" required>
                                <span class="input-hint">Range normal: 18-25¬∞C</span>
                            </div>
                            <div class="form-group">
                                <label for="humidity"><i class="fas fa-water"></i> Kelembaban (%)</label>
                                <input type="number" id="humidity" name="humidity" step="0.1" placeholder="Contoh: 45" required>
                                <span class="input-hint">Range normal: 40-60%</span>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="acStatus"><i class="fas fa-snowflake"></i> Status AC</label>
                                <select id="acStatus" name="acStatus" required>
                                    <option value="">Pilih Status</option>
                                    <option value="normal">Normal</option>
                                    <option value="maintenance">Maintenance</option>
                                    <option value="rusak">Rusak</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="upsStatus"><i class="fas fa-car-battery"></i> Status UPS</label>
                                <select id="upsStatus" name="upsStatus" required>
                                    <option value="">Pilih Status</option>
                                    <option value="normal">Normal</option>
                                    <option value="low_battery">Baterai Rendah</option>
                                    <option value="maintenance">Maintenance</option>
                                    <option value="rusak">Rusak</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-section-title">
                            <h3><i class="fas fa-desktop"></i> Perangkat</h3>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="rackCount"><i class="fas fa-server"></i> Jumlah Rack</label>
                                <input type="number" id="rackCount" name="rackCount" min="0" placeholder="Jumlah rack" required>
                            </div>
                            <div class="form-group">
                                <label for="activeServers"><i class="fas fa-desktop"></i> Server Aktif</label>
                                <input type="number" id="activeServers" name="activeServers" min="0" placeholder="Server aktif" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="powerUsage"><i class="fas fa-bolt"></i> Penggunaan Daya (kW)</label>
                                <input type="number" id="powerUsage" name="powerUsage" step="0.01" placeholder="Contoh: 5.75" required>
                            </div>
                            <div class="form-group">
                                <label for="fireExtinguisher"><i class="fas fa-fire-extinguisher"></i> Status APAR</label>
                                <select id="fireExtinguisher" name="fireExtinguisher" required>
                                    <option value="">Pilih Status</option>
                                    <option value="siap">Siap Pakai</option>
                                    <option value="expired">Expired</option>
                                    <option value="maintenance">Perlu Maintenance</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-section-title">
                            <h3><i class="fas fa-clipboard"></i> Catatan</h3>
                        </div>

                        <div class="form-group full-width">
                            <label for="notes"><i class="fas fa-pen"></i> Catatan Tambahan</label>
                            <textarea id="notes" name="notes" rows="4" placeholder="Masukkan catatan atau temuan penting..."></textarea>
                        </div>

                        <div class="form-actions">
                            <button type="reset" class="btn btn-secondary">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Simpan Data
                            </button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- History Section -->
            <section class="tab-content" id="history">
                <div class="history-section">
                    <div class="section-header">
                        <h2><i class="fas fa-history"></i> Riwayat Monitoring</h2>
                        <div class="export-buttons">
                            <button id="exportExcel" class="btn btn-success">
                                <i class="fas fa-file-excel"></i> Export Excel
                            </button>
                            <button id="exportPDF" class="btn btn-danger">
                                <i class="fas fa-file-pdf"></i> Export PDF
                            </button>
                        </div>
                    </div>

                    <div class="filter-section">
                        <div class="filter-group">
                            <label><i class="fas fa-filter"></i> Filter:</label>
                        </div>
                        <div class="filter-group">
                            <input type="date" id="filterStartDate" placeholder="Tanggal Awal">
                        </div>
                        <div class="filter-group">
                            <input type="date" id="filterEndDate" placeholder="Tanggal Akhir">
                        </div>
                        <button id="applyFilter" class="btn btn-primary">
                            <i class="fas fa-search"></i> Terapkan
                        </button>
                        <button id="resetFilter" class="btn btn-secondary">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                        <button id="clearAllData" class="btn btn-danger" title="Hapus Semua Data">
                            <i class="fas fa-trash"></i> Hapus Semua Data
                        </button>
                    </div>

                    <div class="table-container">
                        <table class="data-table" id="dataTable">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Tanggal</th>
                                    <th>Waktu</th>
                                    <th>Suhu (¬∞C)</th>
                                    <th>Kelembaban (%)</th>
                                    <th>Status AC</th>
                                    <th>Status UPS</th>
                                    <th>Server Aktif</th>
                                    <th>Daya (kW)</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                            </tbody>
                        </table>
                        <div id="loadingIndicator" style="text-align: center; padding: 40px;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--primary-color);"></i>
                            <p style="margin-top: 10px;">Memuat data...</p>
                        </div>
                    </div>

                    <div class="pagination" id="pagination">
                    </div>
                </div>
            </section>

            <!-- Reports Section -->
            <section class="tab-content" id="reports">
                <div class="reports-section">
                    <div class="section-header">
                        <h2><i class="fas fa-chart-bar"></i> Laporan Bulanan</h2>
                        <div class="report-actions">
                            <select id="monthSelect" class="month-select">
                                <option value="">Pilih Bulan</option>
                            </select>
                            <button id="refreshReports" class="btn btn-secondary">
                                <i class="fas fa-redo"></i> Refresh
                            </button>
                            <button id="exportMonthlyExcel" class="btn btn-success">
                                <i class="fas fa-file-excel"></i> Export Excel
                            </button>
                            <button id="exportMonthlyPDF" class="btn btn-danger">
                                <i class="fas fa-file-pdf"></i> Export PDF
                            </button>
                        </div>
                    </div>

                    <div class="monthly-summary">
                        <div class="summary-card">
                            <h4><i class="fas fa-clipboard-list"></i> Total Pencatatan</h4>
                            <p class="value" id="monthlyRecords">0</p>
                        </div>
                        <div class="summary-card">
                            <h4><i class="fas fa-thermometer-half"></i> Suhu Rata-rata</h4>
                            <p class="value" id="monthlyAvgTemp">-- ¬∞C</p>
                            <span class="status-badge" id="monthlyTempStatus">--</span>
                        </div>
                        <div class="summary-card">
                            <h4><i class="fas fa-water"></i> Kelembaban Rata-rata</h4>
                            <p class="value" id="monthlyAvgHumidity">-- %</p>
                            <span class="status-badge" id="monthlyHumidityStatus">--</span>
                        </div>
                        <div class="summary-card">
                            <h4><i class="fas fa-bolt"></i> Daya Rata-rata</h4>
                            <p class="value" id="monthlyAvgPower">-- kW</p>
                        </div>
                    </div>

                    <div class="monthly-stats">
                        <div class="stat-group">
                            <h4><i class="fas fa-temperature-high"></i> Suhu</h4>
                            <div class="stat-row">
                                <span>Minimum:</span>
                                <span class="stat-value" id="monthlyMinTemp">-- ¬∞C</span>
                            </div>
                            <div class="stat-row">
                                <span>Maksimum:</span>
                                <span class="stat-value" id="monthlyMaxTemp">-- ¬∞C</span>
                            </div>
                        </div>
                        <div class="stat-group">
                            <h4><i class="fas fa-water"></i> Kelembaban</h4>
                            <div class="stat-row">
                                <span>Minimum:</span>
                                <span class="stat-value" id="monthlyMinHumidity">-- %</span>
                            </div>
                            <div class="stat-row">
                                <span>Maksimum:</span>
                                <span class="stat-value" id="monthlyMaxHumidity">-- %</span>
                            </div>
                        </div>
                        <div class="stat-group">
                            <h4><i class="fas fa-chart-pie"></i> Distribusi Status</h4>
                            <div class="stat-row">
                                <span class="status-indicator normal"></span>
                                <span>Normal:</span>
                                <span class="stat-value" id="monthlyNormalDays">0 hari</span>
                            </div>
                            <div class="stat-row">
                                <span class="status-indicator warning"></span>
                                <span>Warning:</span>
                                <span class="stat-value" id="monthlyWarningDays">0 hari</span>
                            </div>
                            <div class="stat-row">
                                <span class="status-indicator danger"></span>
                                <span>Danger:</span>
                                <span class="stat-value" id="monthlyDangerDays">0 hari</span>
                            </div>
                        </div>
                        <div class="stat-group">
                            <h4><i class="fas fa-tools"></i> Issues</h4>
                            <div class="stat-row">
                                <span>Masalah AC:</span>
                                <span class="stat-value" id="monthlyACIssues">0</span>
                            </div>
                            <div class="stat-row">
                                <span>Masalah UPS:</span>
                                <span class="stat-value" id="monthlyUPSIssues">0</span>
                            </div>
                        </div>
                    </div>

                    <div class="charts-container">
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3><i class="fas fa-chart-line"></i> Tren Bulanan</h3>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="monthlyTrendChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3><i class="fas fa-chart-bar"></i> Distribusi Status</h3>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="monthlyStatusChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Config Section -->
            <section class="tab-content" id="config">
                <div class="input-section">
                    <div class="section-header">
                        <h2><i class="fas fa-cog"></i> Konfigurasi Firebase</h2>
                    </div>
                    
                    <div class="config-info">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <p><strong>Untuk mengaktifkan database real-time:</strong></p>
                            <ol>
                                <li>Buka <a href="https://console.firebase.google.com/" target="_blank">Firebase Console</a></li>
                                <li>Buat project baru atau pilih project yang ada</li>
                                <li>Tambahkan aplikasi web (icon "</>")</li>
                                <li>Copy konfigurasi Firebase yang diberikan</li>
                                <li>Edit file <code>index.html</code> dan replace konfigurasi di bagian Firebase Config</li>
                                <li>Di Firestore Database, buat database dan atur rules agar terbuka untuk publik (untuk testing)</li>
                            </ol>
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="firebaseApiKey"><i class="fas fa-key"></i> API Key</label>
                            <input type="text" id="firebaseApiKey" placeholder="YOUR_API_KEY">
                        </div>
                        <div class="form-group full-width">
                            <label for="firebaseProjectId"><i class="fas fa-project-diagram"></i> Project ID</label>
                            <input type="text" id="firebaseProjectId" placeholder="YOUR_PROJECT_ID">
                        </div>
                        <div class="form-group full-width">
                            <label for="firebaseConfig"><i class="fas fa-code"></i> Full Config (JSON)</label>
                            <textarea id="firebaseConfig" rows="6" placeholder='{
  "apiKey": "...",
  "authDomain": "...",
  "projectId": "...",
  "storageBucket": "...",
  "messagingSenderId": "...",
  "appId": "..."
}'></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="button" id="saveFirebaseConfig" class="btn btn-primary">
                                <i class="fas fa-save"></i> Simpan Konfigurasi
                            </button>
                            <button type="button" id="testFirebaseConnection" class="btn btn-secondary">
                                <i class="fas fa-plug"></i> Test Koneksi
                            </button>
                        </div>
                        
                        <div id="configStatus" style="margin-top: 20px;"></div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p>&copy; 2024 Monitoring Ruang Server - Sistem Monitoring Terintegrasi dengan Firebase</p>
        </footer>
    </div>

    <!-- Modal Edit -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Edit Data Monitoring</h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <form id="editForm" class="monitoring-form">
                <input type="hidden" id="editId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="editDate"><i class="fas fa-calendar"></i> Tanggal</label>
                        <input type="date" id="editDate" name="editDate" required>
                    </div>
                    <div class="form-group">
                        <label for="editTime"><i class="fas fa-clock"></i> Waktu</label>
                        <input type="time" id="editTime" name="editTime" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editTemperature"><i class="fas fa-thermometer-half"></i> Suhu (¬∞C)</label>
                        <input type="number" id="editTemperature" name="editTemperature" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="editHumidity"><i class="fas fa-water"></i> Kelembaban (%)</label>
                        <input type="number" id="editHumidity" name="editHumidity" step="0.1" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editAcStatus"><i class="fas fa-snowflake"></i> Status AC</label>
                        <select id="editAcStatus" name="editAcStatus" required>
                            <option value="normal">Normal</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="rusak">Rusak</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editUpsStatus"><i class="fas fa-car-battery"></i> Status UPS</label>
                        <select id="editUpsStatus" name="editUpsStatus" required>
                            <option value="normal">Normal</option>
                            <option value="low_battery">Baterai Rendah</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="rusak">Rusak</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editActiveServers"><i class="fas fa-desktop"></i> Server Aktif</label>
                        <input type="number" id="editActiveServers" name="editActiveServers" required>
                    </div>
                    <div class="form-group">
                        <label for="editPowerUsage"><i class="fas fa-bolt"></i> Daya (kW)</label>
                        <input type="number" id="editPowerUsage" name="editPowerUsage" step="0.01" required>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelEdit">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <div class="toast-content">
            <i class="fas fa-check-circle"></i>
            <span id="toastMessage">Berhasil disimpan!</span>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="app.js"></script>
</body>
</html>
